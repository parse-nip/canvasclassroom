<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google" value="notranslate">
  <link rel="shortcut icon" href="static/favicon.ico">
  <title>Scratch 3.0 GUI</title>
  <script defer src="gui.js"></script>
  <script>
    // Project queue for when VM is not yet ready
    let pendingProject = null;

    // Handle messages from parent for project data
    window.addEventListener('message', function (event) {
      if (event.data?.type === 'GET_PROJECT') {
        if (window.vm) {
          // Use saveProjectSb3 to get the full project including assets (zip blob)
          window.vm.saveProjectSb3().then(blob => {
            const reader = new FileReader();
            reader.onload = () => {
              const base64Data = reader.result;
              console.log('ðŸ“¤ Sending full SB3 project data (base64), size:', base64Data.length);
              event.source.postMessage({
                type: 'SCRATCH_PROJECT_DATA',
                project: base64Data
              }, event.origin === 'null' ? '*' : event.origin);
            };
            reader.readAsDataURL(blob);
          });
        } else {
          console.warn('VM not available yet');
          event.source.postMessage({
            type: 'SCRATCH_PROJECT_DATA',
            project: null,
            error: 'VM not ready'
          }, event.origin === 'null' ? '*' : event.origin);
        }
      }

      if (event.data?.type === 'LOAD_PROJECT') {
        if (window.vm) {
          const projectData = event.data.project;
          console.log('ðŸ“¥ Loading project request received');

          let loadPromise;

          // Check if it's a Base64 Data URI (new format)
          if (typeof projectData === 'string' && projectData.startsWith('data:')) {
            console.log('ðŸ“¥ Loading from Base64 SB3 data');
            loadPromise = fetch(projectData)
              .then(res => res.arrayBuffer())
              .then(buffer => window.vm.loadProject(buffer));
          } else {
            // Legacy JSON format
            console.log('ðŸ“¥ Loading from JSON object/string');
            loadPromise = window.vm.loadProject(projectData);
          }

          loadPromise
            .then(() => {
              console.log('ðŸ“¥ Project loaded successfully');
              window.parent.postMessage({ type: 'PROJECT_LOADED' }, '*');
            })
            .catch(e => {
              console.error('Load error:', e);
              window.parent.postMessage({ type: 'PROJECT_LOAD_ERROR', error: e.message }, '*');
            });
        } else {
          console.log('ðŸ“¥ VM not ready, queuing project');
          pendingProject = event.data.project;
        }
      }
    });

    // Log when VM becomes available
    let vmCheckCount = 0;
    const checkVM = setInterval(() => {
      vmCheckCount++;
      if (window.vm) {
        console.log('âœ… VM available on window.vm after', vmCheckCount, 'checks');
        clearInterval(checkVM);

        // Load pending project if one was queued
        if (pendingProject) {
          console.log('ðŸ“¥ Loading queued project');
          window.vm.loadProject(pendingProject)
            .then(() => {
              console.log('ðŸ“¥ Queued project loaded');
              window.parent.postMessage({ type: 'PROJECT_LOADED' }, '*');
              pendingProject = null;
            })
            .catch(e => {
              console.error('Queued load error:', e);
              window.parent.postMessage({ type: 'PROJECT_LOAD_ERROR', error: e.message }, '*');
              pendingProject = null;
            });
        }
      } else if (vmCheckCount > 60) { // Increased timeout to 30s
        console.warn('VM not found after 60 checks');
        clearInterval(checkVM);
      }
    }, 500);
  </script>
</head>

<body>
</body>

</html>